---
title: "修改后纯验证"
author: "Yan Ren"
date: "2023-08-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(Matrix)
library(flexmix)
library(readr)
source("sim.R")
source("tools.R")
source("func.R")
```

```{r}
n <- 500
p <- 8
q <- 4
epsilon_sd <- 0.5
sigma_est <- as.numeric(epsilon_sd)
signal_size <- 1
beta_vlen <- 3
alpha_vlen <- 2
save_path <- "temp.csv"
dt_seed <- 9
K_up <- 6  # 估计时的最大类别，应该不少于 group_num_sub
print("*")

cotype_x <- "En"
cotype_z <- "En"
# epsilon_sd <- 0.5
beta_nonzero <- c(-2, -2, 2, 2)*signal_size # 长度应和真实 group_num_sub 保持一致
# beta_nonzero <- c(-3, -1, 1, 3) # 长度应和真实 group_num_sub 保持一致
alpha_nonzero <- c(-3, -1, 1, 3)*signal_size
# alpha_nonzero <- c(-2, -2, 2, 2) # 验证最简单情况不需要 alpha
# alpha_nonzero <- c(0, 0, 0, 0) # 验证最简单情况不需要 alpha
# beta_vlen <- 3
# alpha_vlen <- 2

q_c_seed_max <- 20
group_num_main <- 2                    
group_num_sub <- 4    
hier_struc <- list(c(1,2),c(3,4))
prob_sub <- rep(1/group_num_sub, group_num_sub)  
reverse <- FALSE
```

```{r}
whole.data <- generate_all_data(dt_seed, n, p, q, prob_sub, hier_struc, 
                                beta_nonzero, alpha_nonzero, beta_vlen, alpha_vlen, 
                                cotype_x, cotype_z, epsilon_sd, reverse)
X <- whole.data$data$X
Z <- whole.data$data$Z
data <- whole.data$data$data_full
coef <- whole.data$coef
# coefv <- lapply(coef, as.vector) # 按照类别拉长
ci_sim <- whole.data$ci_sim
y <- matrix(whole.data$y, ncol=1)

# =============================== prepare =================================
comb_pair <- combn(K_up, 2)
H_p <- kronecker(t(apply(comb_pair, 2, get_e_mat, K_up)),
                 diag(p)) %>% Matrix(sparse = TRUE)
H_q <- kronecker(t(apply(comb_pair, 2, get_e_mat, K_up)),
                 diag(q)) %>% Matrix(sparse = TRUE)


# =============================== result =================================
colnames_all <- c("dt_seed", "q_c_seed", "aa", "tau", "l1", "l2", "l3",
                  "cdist", "ci_prob_mean", "mse", "sc", "BIC.var",
                  "main_grn", "sub_grn", "valid_hier", 
                  "group_detail", paste0("case_", 1:4), "tag")


result <- as.data.frame(matrix(NaN, nrow = 2, ncol = length(colnames_all)))
colnames(result) <- colnames_all
result$dt_seed <- dt_seed
```

```{r}
q_c_seed <- 1
flemix_forinit <- flexmix_init(q_c_seed, 0)
result[1,'q_c_seed'] <- q_c_seed
result[1,'sub_grn'] <- flemix_forinit$est_sub_grn
result[1,'sc'] <- flemix_forinit$sc_score
result[1,'cdist'] <- flemix_forinit$cdist
result[1,'tag'] <- flemix_forinit$tag

flemix_best <- flexmix_init(q_c_seed, 0.1)
result[2,'q_c_seed'] <- q_c_seed
result[2,'sub_grn'] <- flemix_best$est_sub_grn
result[2,'sc'] <- flemix_best$sc_score
result[2,'cdist'] <- flemix_best$cdist
result[2,'tag'] <- flemix_best$tag
```

```{r}
l2_seq <- c(0, 1, 2, 4, 6)
l3_seq <- c(0, 1, 2, 4, 6)
fix_para <- list(dt_seed = dt_seed, q_c_seed = q_c_seed, lambda_1 = 0.3,
                 aa = 1.2, tau = 1)
# fix_para <- expand.grid(list(dt_seed = dt_seed, q_c_seed = q_c_seed, lambda_1 = 0.3,
#                  aa = 1.2, tau = 1, lambda_2 = l2_seq, lambda_3 = l3_seq))
temp <- tuning_hyper(l2_seq, l3_seq, fix_para, flemix_forinit$coef_full_ori)
# result <- rbind(result, 
#                 tuning_hyper(l2_seq, l3_seq, fix_para, flemix_forinit$coef_full_ori))
```


for(q_c_seed in 1:q_c_seed_max){
  
  # flexmix for initialization
  tryCatch({
    flemix_forinit <- flexmix_init(q_c_seed, 0)
  }, error = function(err) {
    cat("Random Init\n")
    flemix_forinit <- random_init(q_c_seed)
  })
  result[1,'q_c_seed'] <- q_c_seed
  result[1,'sub_grn'] <- flemix_forinit$est_sub_grn
  result[1,'sc'] <- flemix_forinit$sc_score
  result[1,'cdist'] <- flemix_forinit$cdist
  result[1,'tag'] <- flemix_forinit$tag
  
  # flexmix best result (K squeezed)
  tryCatch({
    flemix_best <- flexmix_init(q_c_seed, 0.1)
  }, error = function(err) {
    cat("Random Init\n")
    flemix_best <- random_init(q_c_seed)
  })
  result[2,'q_c_seed'] <- q_c_seed
  result[2,'sub_grn'] <- flemix_best$est_sub_grn
  result[2,'sc'] <- flemix_best$sc_score
  result[2,'cdist'] <- flemix_best$cdist
  result[2,'tag'] <- flemix_best$tag

  
  # our method
 
}
write_csv(result, file=save_path, col_names=!file.exists(save_path), append=TRUE)





