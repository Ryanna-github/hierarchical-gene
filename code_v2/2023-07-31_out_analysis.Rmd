---
title: "结果分析"
author: "Yan Ren"
date: "2023-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# terminal generator

## sim

Rscript --verbose test.R -n 500 --dt_seed 9 -p 8 -q 4 -e 0.5 --beta_vlen 3 --alpha_vlen 2 --K_up 4 --path 2023-11-28_n500_p8_q4_bl3_al2_eps0.5_Kup4_fminit.csv >> 2023-11-28_n500_p8_q4_bl3_al2_eps0.5_Kup4_fminit_log.out

```{r}
library(glue)
n <- 500
p <- 8
q <- 4
epsilon_sd <- 0.5
epsilon_sd_init <- 0.5
signal_size <- 1
beta_vlen <- 3
alpha_vlen <- 2
rho_ratio <- 0.2
# dt_seed <- 9
K_up <- 4
for(dt_seed in seq(9, 99, 10)){
  prefix <- "hierarchical-gene/code_v2/"
  # prefix <- ""
    path_pre <- glue("{prefix}{Sys.Date()}_n{n}_p{p}_q{q}_ss{signal_size}_bl{beta_vlen}_al{alpha_vlen}_eps{epsilon_sd}_epi{epsilon_sd_init}_rr{rho_ratio}_Kup{K_up}_fminit")
  # path_pre <- glue("2023-07-31_n{n}_p{p}_q{q}_bl{beta_vlen}_al{alpha_vlen}_eps{epsilon_sd}_fminit")
  cmd <- glue("Rscript --verbose {prefix}test.R -n {n} --dt_seed {dt_seed} -p {p} -q {q} -e {epsilon_sd} --epsilon_sd_init {epsilon_sd_init} --rho_ratio {rho_ratio} --signal_size {signal_size} --beta_vlen {beta_vlen} --alpha_vlen {alpha_vlen} --K_up {K_up} --path {path_pre}.csv >> {path_pre}_log.out")
  print(cmd)
}
```

## real


```{r}
library(glue)
n <- 160
p <- 6
q <- 30
epsilon_sd <- 0.5
K_up <- 8
prefix <- "hierarchical-gene/code_v2/"
prefix <- ""
path_pre <- glue("{prefix}{Sys.Date()}_real_n{n}_p{p}_q{q}_eps{epsilon_sd}_Kup{K_up}_fminit")
# path_pre <- glue("2023-07-31_n{n}_p{p}_q{q}_bl{beta_vlen}_al{alpha_vlen}_eps{epsilon_sd}_fminit")
cmd <- glue("Rscript --verbose {prefix}real.R -n {n} -p {p} -q {q} -e {epsilon_sd} --K_up {K_up} --path {path_pre}.csv >> {path_pre}_log.out")
print(cmd)
```


## log.out

```{r}
# 提取分析 .out 文件
# out <- read.delim("main_test2.out")
# library(stringr)
# info_qc <- str_extract_all(out, '(?<=q_c_seed )\\d')
# info_aa <- str_extract_all(out, '(?<= a )[\\d\\.]*')
# info_l1 <- str_extract_all(out, '(?<= l1 )[\\d\\.]*')
# info_l2 <- str_extract_all(out, '(?<= l2 )[\\d\\.]*')
# info_l3 <- str_extract_all(out, '(?<= l3 )[\\d\\.]*')
# info_tau <- str_extract_all(out, '(?<= tau )[\\d\\.e-]*')
# info_sc <- str_extract_all(out, '(?<=\\[1\\] )[\\d]*[\\.]+[\\d]*')
# 
# 
# 
# outres <- cbind(data.frame(q_c_seed = info_qc[[1]], 
#                            aa = info_aa[[1]],
#                            l1 = info_l1[[1]],
#                            l2 = info_l2[[1]],
#                            l3 = info_l3[[1]],
#                            tau = info_tau[[1]]), t(matrix(info_sc[[1]], nrow = 2)))
# colnames(outres) <- c("q_c_seed", 'aa', "l1", "l2", "l3", "tau", "cdist", "mse")
# write.csv(outres, file = "out.csv", row.names = F)
# 
# 
# plot(outres$mse, outres$cdist)
# par(mfrow = c(2,5))
# plot(outres$aa, outres$mse)
# plot(outres$l1, outres$mse)
# plot(outres$l2, outres$mse)
# plot(outres$l3, outres$mse)
# plot(outres$tau, outres$mse)
# 
# plot(outres$aa, outres$cdist)
# plot(outres$l1, outres$cdist)
# plot(outres$l2, outres$cdist)
# plot(outres$l3, outres$cdist)
# plot(outres$tau, outres$cdist)
```



# csv result

```{r}
library(ggplot2)
library(dplyr)
# library(plotly)
df <- read.csv("2024-02-24_n500_p8_q4_bl3_al2_eps0.5_Kup4_fminit.csv")
# df <- read.csv("2024-02-25_n500_p8_q4_ss1_bl3_al2_eps0.5_epi0.5_Kup4_fminit.csv")
# df <- read.csv("2024-02-24_n500_p8_q4_ss_2_bl3_al2_eps0.5_Kup4_fminit.csv")
# df <- read.csv("2024-02-24_n500_p8_q4_bl3_al2_eps0.5_Kup6_fminit.csv")
# 以下方法过期，直接看 tag 列即可
# df <- df %>% mutate(method = ifelse(q_c_seed < 100, 1, 0))
# df$method <- ifelse(df$q_c_seed == 111, -1, df$method)
# df$method <- factor(df$method, levels = c(-1, 0, 1), labels = c("random", "flexmix", "our_method"))
# df %>% mutate(method = vec_case_when(q_c_seed < 100 ~ q_c_seed,
#                        q_c_seed == 111 ~ -1,
#                        q_c_seed == 999 ~ 0))
# df$method <- factor(as.integer(df$q_c_seed %in% c(111, 999)), levels = c(0,1), labels = c("our method", "flemix or random"))
```

```{r}
df_report <- df %>% 
  select(dt_seed, q_c_seed, mse, sc, ari, tag, main_grn, sub_grn, bic_mean, cdist) %>%
  group_by(dt_seed, q_c_seed, tag) %>% 
  arrange(bic_mean) %>%
  filter(tag == 'hier') %>%
  filter(row_number() == 1) %>%
  arrange(dt_seed, q_c_seed)
df_report2 <- df_report %>%
  group_by(dt_seed) %>%
  summarise(per_main = sum(main_grn == 2)/n(),
            per_sub = sum(sub_grn == 4)/n(),
            sc = max(sc),
            ari = max(ari))
colMeans(df_report2)
```

```{r}
df %>% filter(tag == 'flexmix') %>% select(sc, ari) %>% colMeans(na.rm = T)
```


```{r}
df_report %>%
  group_by(dt_seed) %>%
  summarise(per_main = sum(main_grn == 2)/n(),
            per_sub = sum(sub_grn == 4)/n(),
            sc = max(sc),
            ari = max(ari))
```


```{r}
ggplot(df_report, aes(x = sc, fill = tag)) +
  geom_histogram(position = "identity")
```


```{r}
df_report %>% arrange(-sc)
```


```{r}
ggplot(df_report, aes(x = sc, y = cdist, col = tag)) +
  geom_point(aes(size = 2, alpha = 0.5)) +
  theme_bw() +
  facet_wrap(~ dt_seed) +
  guides(size = FALSE, alpha = FALSE)
```


# score

```{r}
library(ggplot2)
library(dplyr)
library(plotly)
library(simplermarkdown)

# df <- read.csv("2023-11-30_n500_p8_q4_bl3_al2_eps0.5_Kup4_fminit.csv")
# df <- read.csv("2023-12-01_n500_p8_q4_bl3_al2_eps0.5_Kup6_fminit.csv")
# df <- read.csv("2023-12-06_n500_p40_q4_bl3_al2_eps0.5_Kup4_fminit.csv")
# df <- read.csv("2023-12-10_n500_p40_q4_bl3_al2_eps0.5_Kup6_fminit.csv")
# df <- read.csv("2023-12-12_n500_p80_q4_bl3_al2_eps0.5_Kup4_fminit.csv")
# df <- read.csv("2023-12-18_n500_p8_q40_bl3_al2_eps0.5_Kup4_fminit.csv")
# df <- read.csv("2023-12-18_n500_p8_q40_bl3_al2_eps0.5_Kup6_fminit.csv")
# df <- read.csv("2023-12-28_n500_p8_q40_bl3_al10_eps0.5_Kup4_fminit.csv")

df <- read.csv("2023-12-22_real_n160_p6_q20_eps0.5_Kup8_fminit.csv")
df <- read.csv("2023-12-29_real_n160_p6_q30_eps0.5_Kup8_fminit.csv")
# 以下废弃，仅针对很久版本的数据记录样式
# df <- df %>% mutate(method = ifelse(q_c_seed < 100, 1, 0))
# df$method <- ifelse(df$q_c_seed == 111, -1, df$method)
# df$method <- factor(df$method, levels = c(-1, 0, 1), labels = c("random", "flexmix", "hier"))
```

```{r}
df_tmp2 <- df %>%
  # group_by(dt_seed, q_c_seed) %>%
  group_by(dt_seed) %>%
  filter(bic_mean == min(bic_mean, na.rm = TRUE)) %>%
  mutate(filter_type = "bic_mean")

df_compare <- df %>%
  filter(tag == 'flexmix') %>%
  group_by(dt_seed) %>%
  filter(sc == min(sc)) %>%
  mutate(filter_type = "bic_mean") %>%
  select(dt_seed, sc) %>%
  rename(sc_flexmix = sc) %>%
  filter(row_number() == 1)
```

```{r}
df_report <- df_tmp %>% 
  select(dt_seed, q_c_seed, aa, tau, l1, l2, l3, cdist, sc, bic_mean, main_grn, sub_grn) %>%
  group_by(dt_seed) %>%
  filter(row_number() == 1) 

df_report <- merge(df_report, df_compare) %>%
  mutate(sc = round(sc, 3),
         sc_flexmix = round(sc_flexmix, 3),
         bic_mean = round(bic_mean, 3)) %>%
  rename(bic = bic_mean)
md_table(df_report)
```




```{r}
df1 <- df %>%
  group_by(q_c_seed) %>%
  filter(fit_sum == min(fit_sum, na.rm = TRUE)) %>%
  mutate(filter_type = "fit_sum")
df2 <- df %>%
  group_by(q_c_seed) %>%
  filter(fit_mean == min(fit_mean, na.rm = TRUE)) %>%
  mutate(filter_type = "fit_mean")
df3 <- df %>%
  group_by(q_c_seed) %>%
  filter(bic_sum == min(bic_sum, na.rm = TRUE)) %>%
  mutate(filter_type = "bic_sum")
df4 <- df %>%
  group_by(q_c_seed) %>%
  filter(bic_mean == min(bic_mean, na.rm = TRUE)) %>%
  mutate(filter_type = "bic_mean")
df_tmp <- rbind(df1, df2, df3, df4)
```


```{r}
df$q_c_seed <- factor(df$q_c_seed)
df_tmp$q_c_seed <- factor(df_tmp$q_c_seed)
ggplot(df, aes(x = cdist, y = fit_sum)) +
  geom_point(aes(alpha = 0.4)) +
  theme_bw() +
  facet_wrap(~ q_c_seed)
```







